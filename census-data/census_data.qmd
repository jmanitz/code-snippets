---
title: "Working with US Census Data"
author: "Juliane Manitz"
date: "`r Sys.Date()`"
format: gfm
editor: visual
toc: true
execute:
  cache: true
  echo: true
  warning: false
  message: false
---

## Overview

This project illustrates retrieval and processing of United States Census Bureau data for data scientists, who need to automate the collection of demographic information.

The code snippets use different `R` packages to combine different data sources:

-    `tigris` for US map shapefiles,
-   `tidycensus` for US Census Data from American Community Survey,
-   `censusapi` for US Economic Census Data, and
-   `tidyUSDA` for United States Department of Agriculture (USDA) Census Data.

```{r}
require(tidyverse)
require(stringr)
require(sf)

# Census Data API Handling 
require(tigris)     # Map Shapefiles
require(tidycensus) # US Census Data from ACS
require(censusapi)  # US Economic Census Data
require(tidyUSDA)   # USDA Census 

options(tigris_use_cache =TRUE)
source("../read_keys.R") # API keys
```

## United States Map Shapefiles

We are utilizing the `tigris` package, which provides a convenient way to access and work with geographic data from the US Census Bureau, specifically the TIGER/Line shapefiles (see <https://www.census.gov/cgi-bin/geo/shapefiles/index.php> for details).

**States boundaries:** States and equivalent entities are the primary governmental divisions of the US (reduced to mainland)

```{r}
smap <- tigris::states(progress_bar = FALSE) |> 
  filter(!STATEFP %in% c("02","15","72","60","81","07","64","14","66","69","78")) 
```

**County boundaries:** Primary legal divisions such as US counties or comparable (restricted to mainland)

```{r}
cnty <- tigris::counties(filter_by = st_bbox(smap)) 
```

**ZIP codes**: Zip Code Tabulation Area (ZCTA) are generalized areal representations of the United States Postal Service (USPS) ZIP codes service areas.

```{r}
#| cache: true 
zips <- tigris::zctas(progress_bar = FALSE)
```

**Highways**: Federal interstate highway system or under state management. These highways are distinguished by the presence of interchanges and are accessible by ramps and may include some toll highways

```{r}
#| cache: true 
hwy <- tigris::primary_roads(filter_by = st_bbox(smap), progress_bar = FALSE)
```

**Note:** Projection NAD83 (North American Datum 1983) = EPSG:4269

**Plot US Map with States, Counties and Highways**

```{r}
#| cache: true 
ggplot() + theme_void() +    
  geom_sf(data = cnty, fill="Whitesmoke", color="lightgrey", lty=1) +   
  geom_sf(data = smap, color="Black", fill=NA) +    
  geom_sf(data = hwy, fill=NA, color="blue", lty=1) 
```

## American Community Survey

We use the `tidycensus` package that allows us to interface with a select number of the US Census Bureau’s data APIs and return tidyverse-ready data frames, optionally with simple feature geometry included.

The American Community Survey (ACS) is an ongoing, mandatory survey by the U.S. Census Bureau. Unlike the once-a-decade census, the ACS gathers data every year. It surveys a sample of 3.5m households, asking about social (education, language), demographic (age, race), economic (income, employment), and housing (costs, internet access) characteristics.

### Derived Variables

**Demographics**

-   `pop_2023` Total Population in 2023
-   `pop_density` Population density in 2023.
-   `median_age` Median Age
-   `born_citizen` Nativity and Citizenship Status, born in the United States

**Housing**

-   `housing_units` Number of Housing Units
-   `single_household` Proportion of Single person Household (Household size)

**Education**

-   `school` Proportion population enrolled in school
-   `higher_ed` Proportion population with higher education (Bachelor's, Master's, Professional School, Doctorate degree) for Population \> 25 Years

**Income**

-   `median_income` Median household income in the past 12 months (in 2023 inflation-adjusted dollars)
-   `gini_inequality` Gini Index of Income Inequality

**Commuting**

-   `commute_time` Aggregate Travel Time to Work (in Minutes) of Worker
-   `commute_carfree` Car-free Means of Transportation to Work: Public Transportation, Bicycle, Walked

See complete list of Source ACS Variables: https://api.census.gov/data/2023/acs/acs5/variables.html

### Source Code

```{r}
#| cache: true 
cnsdt <- get_acs(
  geography = "county", survey = "acs5", year = 2023, output="wide", geometry =TRUE, keep_geo_vars=TRUE,
  variables = c(
    # Demographics 
    "B01001_001", "B01002_001", "B05001_002",
    # Housing
    "B25001_001", "B11016_010", 
    # Education
    "B14001_002", "B15003_022", "B15003_023", "B15003_024", "B15003_025",
    # Income
    "B19013_001", "B19083_001", 
    # Commuting
    "B08006_001E", "B08006_008", "B08006_014", "B08006_015", "B08013_001"
  ), progress_bar = FALSE) |> 
  # Select Estimates
  select(GEOID, NAMELSAD, STUSPS, STATEFP, ALAND, B01001_001E, ends_with("E")) |> 
  # Calculate Variables
  transmute(
    geoid = GEOID, county = NAMELSAD, state = STATE_NAME, stateN = STATEFP,
    # Population
    pop_2023 = B01001_001E, 
    pop_density = pop_2023/(ALAND/2.59e+6),
    # Demographics
    median_age =	B01002_001E, 
    born_citizen = B05001_002E/pop_2023, 
    # Housing
    housing_units = B25001_001E, 
    single_household = B11016_010E/housing_units, 
    # Education
    school = B14001_002E/pop_2023, 
    higher_ed = (B15003_022E + B15003_023E + B15003_024E + B15003_025E)/pop_2023, 
     # Income
    median_income = B19013_001E, 
    gini_inequality = B19083_001E, 
    # Commuting
    commute_time = B08013_001E, 
    commute_carfree = (B08006_008E + B08006_014E + B08006_015E)/B08006_001E
  ) |> 
  # focus on US mainland only 
  filter(!stateN %in% c("02","15","72","60","81","07","64","14","66","69")) |> select(-stateN) |> 
  st_transform('EPSG:4269')
```

### Example Plot: Commuting

```{r}
ggplot() + theme_void() + 
  labs(title="Aggregate Travel Time to Work (in Minutes) of Worker") +
  geom_sf(data = cnsdt, aes(fill=commute_time), color=NA) +
  scale_fill_distiller(palette = "PRGn", trans="log10", direction = -1) + 
  geom_sf(data = smap, color="darkgray", fill=NA)
```

## Economic Census

We retrieve data from the economic census using `censusapi`, which a wrapper for the US Census Bureau APIs.

### Select Variables

-   time: YEAR
-   location: GEO_ID, COUNTY, STATE, REGION,\
-   business type:
    -   NAICS2022
    -   SECTOR,SUBSECTOR = NAICS economic sector
    -   INDLEVEL, INDGROUP = Industry (Group)
-   ESTAB (fclty) = number of establishments, refers to the count of individual physical business locations,
-   EMP (emply) = number of employees
-   RCPTOT (sales) = Sales, value of shipments, or revenue (\$1,000)

To filter industries of interest with NAICS Codes, we are using the drill-down table (https://www.naics.com/search/#naics), e.g. NAICS Code = 62 for healthcare industry

### Source Code

```{r}
# Select variables from economic census 
ecndt <- getCensus(
  name = "ecnbasic", vintage = 2022, region = "county:*", key = census_key, 
  vars = c("GEO_ID", "NAICS2022", "SECTOR", "SUBSECTOR", "INDLEVEL", "INDGROUP",
           "ESTAB", "EMP", "RCPTOT")) |> 
  # select utility businesses only
  filter(SECTOR == "62" & INDLEVEL == 2) |> 
  transmute(
    geoid = paste0(state, county),
    fclty = ESTAB |> as.numeric(), # Number of establishments
    emply = EMP |> as.numeric(),   # Number of employees
    sales = RCPTOT |> as.numeric() # Sales, value of shipments , or revenue ($1,000)  
  ) 
```

### Example Plot: Healthcare Industry Facilities

Number of establishments, refers to the count of individual physical business locations,

```{r}
left_join(cnsdt, ecndt, by = 'geoid') |> 
  ggplot() + theme_void() + 
    geom_sf(aes(fill=fclty), color=NA) +
    scale_fill_distiller(palette = "PRGn", trans="log10", direction = -1) + 
    geom_sf(data = smap, color="darkgray", fill=NA)
```

### Other available APIs:

-   cbp = County Business Patterns
-   zbp = Zip Code Business Patterns:
-   ewks = Economic Census - All Sectors: Economy-Wide Key Statistics
-   ecnbasic = Economic Census: Summary Statistics for the U.S., States, and Selected Geographies: 2022
-   ecntypop = Economic Census: Wholesale Trade: Detailed Type of Operation for the U.S.: 2022


## USDA Census

Part of the 2022 Economic Census data is conducted by USDA (NAICS 11 - Agriculture, Forestry, Fishing and Hunting). We used the `tidyUSDA` package, which is a tool for gathering USDA data for analysis and visualization, providing an API to pull data from NASS QuickStats.

### Derived Variables

-   `farms` Number of farms with agricultural land, excluding cropland, pastureland and woodland
-   `farms_acres` Acres of agricultural land, excluding cropland, pastureland and woodland
-   `farms_anmls` Number of farms with animal sales, including products
-   `sales_anmls` Total sales by farm animals and animal products
-   `feed_expns` Feed expense, measured in \$

See https://quickstats.nass.usda.gov, to view details on available variables.


### Source Code

```{r, cache=TRUE}
vars <- c(
  "AG LAND, (EXCL CROPLAND & PASTURELAND & WOODLAND) - NUMBER OF OPERATIONS", 
  "AG LAND, (EXCL CROPLAND & PASTURELAND & WOODLAND) - ACRES", 
  "ANIMAL TOTALS, INCL PRODUCTS - OPERATIONS WITH SALES", 
  "ANIMAL TOTALS, INCL PRODUCTS - SALES, MEASURED IN $", 
  "FEED - EXPENSE, MEASURED IN $")

# Run API
out <- lapply(vars, FUN = function(x){
  getQuickstat(key = usda_key, program="CENSUS", data_item = x, geographic_level = "COUNTY", domain = "TOTAL", year = "2022") |> 
    select(state_ansi, county_code, short_desc, unit_desc, Value)
}) |> bind_rows()

usdadt <- out |> 
  transmute(
    geoid = paste0(state_ansi,county_code),
    desc = case_when(
      short_desc == "AG LAND, (EXCL CROPLAND & PASTURELAND & WOODLAND) - NUMBER OF OPERATIONS" ~ "farms",
      short_desc == "AG LAND, (EXCL CROPLAND & PASTURELAND & WOODLAND) - ACRES" ~ "farms_acres", 
      short_desc == "ANIMAL TOTALS, INCL PRODUCTS - OPERATIONS WITH SALES" ~ "farms_anmls", 
      short_desc == "ANIMAL TOTALS, INCL PRODUCTS - SALES, MEASURED IN $" ~ "sales_anmls", 
      short_desc == "FEED - EXPENSE, MEASURED IN $" ~ "feed_expns"),
    val = Value) |>  
  pivot_wider(id_cols = geoid, names_from = desc, values_from = val, values_fill = 0) |> 
  mutate_at(vars(starts_with(c("sales","feed")),), ~./1000) # sales in mm
```

### Example Plot: Feed Expense

```{r}
left_join(cnsdt, usdadt, by = 'geoid') |> ggplot() + 
  geom_sf(aes(fill=feed_expns), color=NA) +
  scale_fill_distiller(palette="PRGn", trans="log10", direction=-1, na.value="whitesmoke", 
                       breaks=c(100,10000,1000000), labels=c("100","10,000","1,000,000")) + 
  geom_sf(data = smap, color="darkgray", fill=NA) + theme_void()
```


## Combine Datasets

```{r}
# Combine with census 
cnty <- purrr::reduce(list(cnsdt, ecndt, usdadt), dplyr::left_join, by = 'geoid')

save(cnty, file="cnty.RData")
```

## Session Information

```{r}
sessionInfo()
```
