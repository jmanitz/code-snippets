---
title: "Soil Test Analysis"
author: "Juliane Manitz"
date: "`r format(Sys.time(),  '%d %B, %Y')`"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyr)
library(ggplot2)
library(paletteer)
library(viridis)
require(plotly)
```

## NPK Plot

* N = Nitrogen, healthy green foliage
* P = Phosphorus, strong roots and biomas; increases bloom and friut production
* K = Potassium, healthy plant growth; fights off diseases

### Mock Data 

```{r}
elmts <- c("Nitrogen (N)","Phosphorus (P)","Potassium (K)")
dt <- data.frame(
  id = rep(paste0("sample",1:3), times=3), 
  element = rep(elmts, each=3), 
  value = c(85, 140, 125,          # N ref 100-130
            75.89, 52.47, 35.26,   # P ref 4-14
            307.91, 135.09, 164.1), # K ref 100-160
  low=NA, high=NA
)

# Define Optimum values for reference 
ref <- data.frame(
  id = "optimum", element = elmts, 
  value=c(120, 8, 130), low=c(110, 4, 100), high=c(130,14,160)
)
```

```{r}
p <- rbind(dt, ref) %>% 
  ggplot(aes(x=element, y=value, fill=id, label=value)) +  
  geom_bar(stat="identity", position=position_dodge()) +
  #geom_text(position=position_dodge()) + # add numbers to top of the bar
  geom_errorbar(aes(ymin=low, ymax=high), width=.2, position=position_dodge(.9)) + 
  scale_fill_paletteer_d("ggthemes::excel_Crop") + 
  labs(title="NPK Macronutrients", x="Macronutirent", y="Test Value", fill="" ) + 
  theme_minimal() #+ coord_flip()

# Make graphics interactive 
ggplotly(p)
```

## pH Plot

```{r}
# Acidic <3.5 - 6.5
# Optimal 5.5-7.0
# Alkaline 7.4->9.0

plot_ly(
  type = "indicator", mode = "gauge+number+delta", #
  #title = list(text = "Soil pH", font = list(size = 24)),
  value = 6.4,
  delta = list(reference = 7, increasing = list(color = "deeppink"), decreasing = list(color = "deeppink")),
  gauge = list(
    axis = list(range = list(NULL, 14), tickwidth = 0.2, tickcolor = "darkgray"),
    bar = list(color = "darkgray", thickness = 0.2),bgcolor = "white", borderwidth = 2, bordercolor = "gray",
    threshold = list(line = list(color = "deeppink", width = 7), thickness = 1, value = 7),
    steps = list(
      list(range = c(0,1), color="tomato"),
      list(range = c(1,2), color="coral"),
      list(range = c(2,3), color="orange"),
      list(range = c(3,4), color="gold"),
      list(range = c(4,5), color="yellow"),
      list(range = c(5,6), color="greenyellow"),
      list(range = c(6,7), color="limegreen"),
      list(range = c(7,8), color="forestgreen"), #"seagreen3"),
      list(range = c(8,9), color="darkcyan"), 
      list(range = c(9,10),color="steelblue"),       
      list(range = c(10,11),color="royalblue"),
      list(range = c(11,12),color="slateblue"),
      list(range = c(12,13),color="RebeccaPurple"),
      list(range = c(13,14),color="indigo")))) %>%
  layout(margin = list(l=20,r=30), font = list(color = "darkblue", family = "Arial"))


```

<!-- https://stackoverflow.com/questions/24900903/how-to-draw-gauge-chart-in-r
```{r, eval = false}
gg.gauge <- function(pos,breaks=c(0,30,70,100)) {
  require(ggplot2)
  get.poly <- function(a,b,r1=0.5,r2=1.0) {
    th.start <- pi*(1-a/100)
    th.end   <- pi*(1-b/100)
    th       <- seq(th.start,th.end,length=100)
    x        <- c(r1*cos(th),rev(r2*cos(th)))
    y        <- c(r1*sin(th),rev(r2*sin(th)))
    return(data.frame(x,y))
  }
  ggplot()+ 
    geom_polygon(data=get.poly(breaks[1],breaks[2]),aes(x,y),fill="red")+
    geom_polygon(data=get.poly(breaks[2],breaks[3]),aes(x,y),fill="gold")+
    geom_polygon(data=get.poly(breaks[3],breaks[4]),aes(x,y),fill="forestgreen")+
    geom_polygon(data=get.poly(pos-1,pos+1,0.2),aes(x,y))+
    geom_text(data=as.data.frame(breaks), size=5, fontface="bold", vjust=0,
              aes(x=1.1*cos(pi*(1-breaks/100)),y=1.1*sin(pi*(1-breaks/100)),label=paste0(breaks,"%")))+
    annotate("text",x=0,y=0,label=pos,vjust=0,size=8,fontface="bold")+
    coord_fixed()+
    theme_bw()+
    theme(axis.text=element_blank(),
          axis.title=element_blank(),
          axis.ticks=element_blank(),
          panel.grid=element_blank(),
          panel.border=element_blank()) 
}
gg.gauge(52,breaks=c(0,35,70,100))
```
-->

## Load Example Test Result

```{r}
dt <- read.csv("data_example.csv", skip=6, stringsAsFactors = FALSE)[c(1:7),c(3,4,6,8,10)] 
colnames(dt) <- c("type","element", paste0("sample",1:3))
dt2 <- dt %>% pivot_longer(cols = starts_with("sample")) %>% transform(value = as.numeric(value))
```

### Plot data

```{r}
dt2 %>% filter(type == "nutrient") %>% 
  ggplot(aes(x=element, y=value, fill=name)) +  
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_viridis(discrete = TRUE) +
  theme_minimal()  + coord_flip()
```

## Session Information (for Reproducibility)

```{r}
print(sessionInfo(), locale = FALSE)
```